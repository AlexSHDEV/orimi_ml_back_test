# Тестовое задание для ORIMI
---
## Этап 1 (ML)
Результатом этого этапа стало **исследование** и **обученная модель**.
 - В исследовании был произведена предобработка данных, созданы новые признаки для обучения, изучена корелляция целевой переменной и всех признаков, а также рассмотрены случаи мультиколлиниарности

### EDA
#### Новые признаки
_Так как сами даты не могут быть в исходной форме использованы в обучении, было принятно решение сразу резюмировать всю важную информацию исходя из временного промежутка, в течении которого происходила акция (вообще говоря, любого временного промежутка из данных)_
- "Promo_duration" : Длительность акции (int);
- "Shipping_duration" : Длительность продаж (int);
- "Right_offset" : Разница между окончанием продаж и окончанием акции. (Сколько после окончания акции шли продажи?) (int);
- "Left_offset" : Разница между началом продаж и началом акции (int);
- "Day_sin" : синус середины временного интервала акции (float);
- "Day_cos" : косинус середины временного интервала акции (float).
Два последних - полярное кодирование дня в году, чтобы сохранить цикличность в числовом представлении данного признака.

#### Обработка данных
- Feat_10 и Feat_7 имеют высокую корелляцию с целевой переменной, но также имеют высокую корелляцию между собой.
- Feat_7, Feat_10 и Feat_11 имеют очень много пропусков. Исходя из ситуации, такие пропуски нельзя заменять каким-либо значением, нужно ставить метку о наличии/отсутсвии данного признака.
- Категориальные признаки "Promo_type", "Promo_class", "Agent", "Promo_id", "Item_id" было решено оставить и закодировать через лейблы. Некоторые из них можно было кодировать one-hot, например множество значений "Agent" имеет мощность = 3.
- Интуитивно кажется, что идентификаторы следует выбросить, но на самом деле, в контексте этой задачи они очень важны. Продаваемый товар, на самом деле, может представляться как более сложная структура, нежели просто идентификатор, который может в себе содержать информацию о его популярности, конкурентности и так далее, что очевидно сильно связано с целевой переменной. На самом деле, в данном наборе данных эти идентификаторы лучше будет закодировать и использовать в обучении.

#### Модели
Были обучены различные модели: Линейная, Ridge, Random Forest, Градиентный бустинг и XGBoost, и все они решали задачу регрессии (очевидно). Из них победителем вышел XGBoost, но целом картина результатов достаточно сомнительная (RMSE ~ 4123). Гиперпараметры подбирались с помощью optuna.

После очевидного превосходства бустинговой модели, было принято решение ослабить предобработку данных, особенно категориальных, и загнать это все в CatBoost (Она достаточно не требовательная модель). Результат улучшился (RMSE ~ 3700). Она же и стала итоговой моделью.

---
## Этап 2 (Backend)
Меня не устроили результаты первого этапа. Я хотел бы получить фидбек от коллег касательно качество такой модели, так как мне кажется, что RMSE=3700 достаточно много.
```
Target
count	14081.000000
mean	3239.999787
std	6534.079963
min	1.000000
25%	260.000000
50%	1132.000000
75%	3359.000000
max	100000.000000
```
В итоге задача была сделана согласно ТЗ, не более. Страшно было вкладывать силы в разработку сервера, когда сомневаешься в решении ML-этапа. А хотя и впрочем, я сам себя ограничил таким маленьким временным промежутком.

Запустить сервер вы можете:
- Скачав к себе этот репозиторий
- ```bash
  pip install -r requirements.txt
  ```

Воспользоваться:
- Обратиться по адресу http://localhost:80/ping
- Отправить в командной строке один из предложенных примеров тестового запроса на inference:
  ```bash
  curl -X POST -H "Content-Type: application/json" -d "{\"promo_start\":\"2024-07-24\",\"promo_end\":\"2024-07-30\",\"shipping_start\":\"2024-06-25\",\"shipping_end\":\"2024-07-30\",\"promo_type\":\"J\",\"feat_2\":10328.21,\"feat_3\":58.22,\"agent\":\"C\",\"promo_id\":\"Promo №5483.0\",\"item_id\":\"Item ID: 125.0\",\"feat_7\":32270.51,\"promo_class\":\"D\",\"feat_9\":84812245.76,\"feat_10\":5718813.46,\"feat_11\":25.96,\"feat_12\":84212}" http://localhost:80/inference
  ```
  ```bash
  curl -X POST -H "Content-Type: application/json" -d "{\"promo_start\":\"2023-07-26\",\"promo_end\":\"2023-08-01\",\"shipping_start\":\"2023-06-27\",\"shipping_end\":\"2023-07-29\",\"promo_type\":\"J\",\"feat_2\":\"31106.3\",\"feat_3\":\"74.74150\",\"agent\":\"C\",\"promo_id\":\"promo№4664.0\",\"item_id\":\"Item ID:109.0\",\"feat_7\":\"2160.40\",\"promo_class\":\"D\",\"feat_9\":\"33799347\",\"feat_10\":\"626591.8\",\"feat_11\":\"50.92550\",\"feat_12\":1130}" http://localhost:80/inference
  ```
  ```bash
  curl -X POST -H "Content-Type: application/json" -d "{\"promo_start\":\"2020-02-26\",\"promo_end\":\"2020-03-03\",\"shipping_start\":\"2020-02-06\",\"shipping_end\":\"2020-02-19\",\"promo_type\":\"L\",\"feat_2\":\"4095.662\",\"feat_3\":\"62.37169\",\"agent\":\"C\",\"promo_id\":\"promo№121.0\",\"item_id\":\"Item ID:77.0\",\"feat_7\":\"nan\",\"promo_class\":\"D\",\"feat_9\":\"nan\",\"feat_10\":\"nan\",\"feat_11\":\"nan\",\"feat_12\":40464}" http://localhost:80/inference
  ```
